-- BLADE BALL AUTO PARRY (BAĞIMSIZ + MENÜLÜ)
-- Tek başına çalışır, ana scripte gerek yok.

local player = game.Players.LocalPlayer
local runService = game:GetService("RunService")
local virtualInput = game:GetService("VirtualInputManager")
local userInputService = game:GetService("UserInputService")
local coreGui = game:GetService("CoreGui")

-- ===== AYARLAR =====
local settings = {
    Enabled = true,          -- Açık/Kapalı
    TriggerRatio = 0.85,     -- Vuruş zamanlaması (0.7 = geç, 0.9 = erken)
    Cooldown = 0.15,         -- Vuruşlar arası bekleme
    ShowVisuals = true,      -- Görsel halka gösterimi
    DistanceLimit = 50,      -- Maksimum algılama mesafesi
}

-- ===== MENÜ OLUŞTURMA =====
local gui = Instance.new("ScreenGui")
gui.Name = "BladeBallAutoParry"
gui.ResetOnSpawn = false
gui.Parent = coreGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 250, 0, 180)
mainFrame.Position = UDim2.new(0.8, -260, 0.5, -90)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BackgroundTransparency = 0.1
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = gui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 15)
UICorner.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 35)
title.BackgroundTransparency = 1
title.Text = "⚡ Auto Parry"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.GothamBold
title.TextSize = 18
title.Parent = mainFrame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0.8, 0, 0, 35)
toggleBtn.Position = UDim2.new(0.1, 0, 0.25, 0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
toggleBtn.Text = "AÇIK"
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 16
toggleBtn.Parent = mainFrame
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0, 8)

local ratioSlider = Instance.new("TextButton")
ratioSlider.Size = UDim2.new(0.8, 0, 0, 35)
ratioSlider.Position = UDim2.new(0.1, 0, 0.5, 0)
ratioSlider.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
ratioSlider.Text = "Zamanlama: %" .. math.floor(settings.TriggerRatio * 100)
ratioSlider.TextColor3 = Color3.new(1, 1, 1)
ratioSlider.Font = Enum.Font.Gotham
ratioSlider.TextSize = 14
ratioSlider.Parent = mainFrame
Instance.new("UICorner", ratioSlider).CornerRadius = UDim.new(0, 8)

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0, 5)
closeBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.new(1, 1, 1)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 16
closeBtn.Parent = mainFrame
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 8)

-- ===== MENÜ İŞLEVLERİ =====
closeBtn.MouseButton1Click:Connect(function()
    gui:Destroy()
end)

toggleBtn.MouseButton1Click:Connect(function()
    settings.Enabled = not settings.Enabled
    toggleBtn.Text = settings.Enabled and "AÇIK" or "KAPALI"
    toggleBtn.BackgroundColor3 = settings.Enabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
end)

ratioSlider.MouseButton1Click:Connect(function()
    settings.TriggerRatio = settings.TriggerRatio + 0.05
    if settings.TriggerRatio > 1 then settings.TriggerRatio = 0.7 end
    ratioSlider.Text = "Zamanlama: %" .. math.floor(settings.TriggerRatio * 100)
end)

-- ===== TOP ALGILAMA =====
local ballsFolder = nil
local function findBallsFolder()
    local possibleNames = {"Balls", "Projectiles", "Throwables", "BallsFolder"}
    for _, name in ipairs(possibleNames) do
        local folder = workspace:FindFirstChild(name)
        if folder then return folder end
    end
    return nil
end

local function getBallSpeed(ball)
    local v = ball.Velocity
    if v and v.Magnitude > 0.1 then return v.Magnitude end
    
    local av = ball.AssemblyLinearVelocity
    if av and av.Magnitude > 0.1 then return av.Magnitude end
    
    local zoomies = ball:FindFirstChild("zoomies")
    if zoomies then
        if zoomies:IsA("BodyVelocity") then
            return zoomies.Velocity.Magnitude
        elseif zoomies:IsA("Vector3Value") then
            return zoomies.Value.Magnitude
        end
    end
    
    for _, child in ipairs(ball:GetChildren()) do
        if child:IsA("BodyVelocity") then
            return child.Velocity.Magnitude
        end
    end
    return 0
end

-- ===== GÖRSEL HALKALAR =====
local rings = {}
local function createVisuals()
    if not settings.ShowVisuals then return end
    local char = player.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    for i = 1, 3 do
        local ring = Instance.new("Part")
        ring.Size = Vector3.new(6, 0.2, 0.2)
        ring.Shape = Enum.PartType.Cylinder
        ring.Anchored = true
        ring.CanCollide = false
        ring.Transparency = 0.4
        ring.BrickColor = BrickColor.new("White")
        ring.Material = Enum.Material.Neon
        ring.Parent = workspace
        table.insert(rings, ring)
    end
    
    spawn(function()
        local angle = 0
        while rings[1] and rings[1].Parent do
            angle = angle + 0.05
            if not root or not root.Parent then break end
            local center = root.CFrame * CFrame.new(0, 1, 0)
            local radius = 3 + (settings.TriggerRatio * 2)  -- zamana göre boyut
            rings[1].CFrame = center * CFrame.Angles(0, angle, 0) * CFrame.new(radius, 0, 0)
            rings[2].CFrame = center * CFrame.Angles(angle, 0, 0) * CFrame.new(0, radius, 0)
            rings[3].CFrame = center * CFrame.Angles(0, angle, 0) * CFrame.Angles(math.pi/2, 0, 0) * CFrame.new(0, radius, 0)
            task.wait(0.03)
        end
    end)
end

player.CharacterAdded:Connect(function()
    for _, r in ipairs(rings) do if r then r:Destroy() end end
    rings = {}
    if settings.ShowVisuals then createVisuals() end
end)

-- ===== ANA PARRY DÖNGÜSÜ =====
local lastParryTime = 0

runService.PreSimulation:Connect(function()
    if not settings.Enabled then return end
    
    local now = tick()
    if now - lastParryTime < settings.Cooldown then return end
    
    local char = player.Character
    if not char then return end
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    if not ballsFolder then ballsFolder = findBallsFolder() end
    if not ballsFolder then return end
    
    for _, ball in ipairs(ballsFolder:GetChildren()) do
        if not ball:IsA("BasePart") then continue end
        
        local distance = (hrp.Position - ball.Position).Magnitude
        if distance > settings.DistanceLimit then continue end
        
        local speed = getBallSpeed(ball)
        if speed < 1 then continue end
        
        local target = ball:GetAttribute("target")
        if target and target ~= player.Name then continue end
        
        local timeToHit = distance / speed
        if timeToHit <= settings.TriggerRatio then
            virtualInput:SendMouseButtonEvent(0, 0, 0, true, game, 0)
            task.wait(0.02)
            virtualInput:SendMouseButtonEvent(0, 0, 0, false, game, 0)
            lastParryTime = now
            break
        end
    end
end)

-- ===== BAŞLANGIÇ =====
task.wait(1)
ballsFolder = findBallsFolder()
if ballsFolder then
    print("✅ Top klasörü bulundu:", ballsFolder.Name)
else
    warn("⚠️ Top klasörü bulunamadı! Lütfen elle kontrol et.")
end
createVisuals()
