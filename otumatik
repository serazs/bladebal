-- ULTIMATE BLADE BALL v4 (EN GELÄ°ÅžMÄ°Åž VERSÄ°YON)
-- Profesyonel otomatik parry + GÃ¶rsel efektler + HÄ±z rekoru

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- ===== GELÄ°ÅžMÄ°Åž AYARLAR =====
local settings = {
    -- Ana ayarlar
    Enabled = true,
    Keybind = Enum.KeyCode.F,
    
    -- VuruÅŸ ayarlarÄ±
    ParryMode = "AGGRESSIVE",  -- "NORMAL", "AGGRESSIVE", "INSTANT"
    PredictTime = 0.45,         -- Tahmin sÃ¼resi (dÃ¼ÅŸÃ¼k=erken vuruÅŸ)
    MaxDistance = 40,            -- Maksimum algÄ±lama mesafesi
    HitChance = 0.98,            -- VuruÅŸ doÄŸruluÄŸu (0.95-1.0 arasÄ±)
    
    -- GÃ¶rsel ayarlar
    Visuals = {
        Enabled = true,
        BallLines = true,        -- Top-oyuncu Ã§izgisi
        PredictionDots = true,    -- Tahmin noktalarÄ±
        Trajectory = true,        -- Top rotasÄ±
        ImpactMarker = true,      -- Ã‡arpma noktasÄ±
        Colors = {
            Line = Color3.fromRGB(255, 50, 50),
            Prediction = Color3.fromRGB(50, 255, 50),
            Trajectory = Color3.fromRGB(255, 255, 0),
            Impact = Color3.fromRGB(255, 0, 255)
        },
        Transparency = 0.3,
        Thickness = 0.5
    },
    
    -- Performans ayarlarÄ±
    Performance = {
        MaxBallsToCheck = 10,     -- Maksimum kontrol edilecek top sayÄ±sÄ±
        UpdateRate = 0.01,         -- GÃ¼ncelleme hÄ±zÄ± (saniye)
        UseParallel = true         -- Paralel iÅŸlem kullan
    }
}

-- ===== DEÄžÄ°ÅžKENLER =====
local ballsFolder = Workspace:FindFirstChild("Balls") 
    or Workspace:FindFirstChild("Projectiles") 
    or Workspace:FindFirstChild("Throwables") 
    or Workspace:FindFirstChild("BallFolder")
    
local lastParryTime = 0
local visualObjects = {}
local ballCache = {}
local frameSkip = 0

-- ===== TOP BULMA FONKSÄ°YONU (EN HIZLI) =====
local function findBalls()
    if not ballsFolder then return {} end
    
    -- Cache kullan (performans iÃ§in)
    if #ballCache > 0 and frameSkip % 3 ~= 0 then
        return ballCache
    end
    
    local balls = {}
    local count = 0
    
    for _, ball in ipairs(ballsFolder:GetChildren()) do
        if ball:IsA("BasePart") and ball.Transparency < 0.5 then
            count = count + 1
            table.insert(balls, ball)
            if count >= settings.Performance.MaxBallsToCheck then
                break
            end
        end
    end
    
    ballCache = balls
    frameSkip = frameSkip + 1
    return balls
end

-- ===== TOP HIZINI VE YÃ–NÃœNÃœ BUL (Ã‡OK GELÄ°ÅžMÄ°Åž) =====
local function getBallData(ball)
    local data = {
        position = ball.Position,
        velocity = ball.Velocity,
        speed = 0,
        direction = Vector3.new(0,0,0),
        timeToHit = 999,
        isDangerous = false
    }
    
    -- HÄ±z kontrolÃ¼
    if ball.Velocity and ball.Velocity.Magnitude > 0.1 then
        data.velocity = ball.Velocity
        data.speed = ball.Velocity.Magnitude
        data.direction = ball.Velocity.unit
    elseif ball.AssemblyLinearVelocity and ball.AssemblyLinearVelocity.Magnitude > 0.1 then
        data.velocity = ball.AssemblyLinearVelocity
        data.speed = ball.AssemblyLinearVelocity.Magnitude
        data.direction = ball.AssemblyLinearVelocity.unit
    else
        -- BodyVelocity ara
        for _, child in ipairs(ball:GetChildren()) do
            if child:IsA("BodyVelocity") and child.Velocity.Magnitude > 0.1 then
                data.velocity = child.Velocity
                data.speed = child.Velocity.Magnitude
                data.direction = child.Velocity.unit
                break
            end
        end
    end
    
    -- Hedef kontrolÃ¼ (attribute)
    local target = ball:GetAttribute("target")
    data.isDangerous = (target == nil or target == player.Name)
    
    return data
end

-- ===== EN TEHLÄ°KELÄ° TOPU BUL (AKILLI ALGILAMA) =====
local function findMostDangerousBall()
    local character = player.Character
    if not character then return nil end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local balls = findBalls()
    local mostDangerous = nil
    local smallestTime = math.huge
    local closestDistance = math.huge
    
    for _, ball in ipairs(balls) do
        local data = getBallData(ball)
        
        if data.isDangerous and data.speed > 5 then
            local toPlayer = hrp.Position - data.position
            local distance = toPlayer.Magnitude
            local dotProduct = toPlayer.unit:Dot(data.direction)
            
            -- Top oyuncuya doÄŸru geliyor mu?
            if dotProduct > 0.3 then
                local timeToHit = distance / data.speed
                
                -- Zaman ve mesafe kontrolÃ¼
                if timeToHit < smallestTime and distance < settings.MaxDistance then
                    smallestTime = timeToHit
                    closestDistance = distance
                    mostDangerous = {
                        ball = ball,
                        data = data,
                        timeToHit = timeToHit,
                        distance = distance,
                        dotProduct = dotProduct
                    }
                end
            end
        end
    end
    
    return mostDangerous
end

-- ===== VURUÅž ZAMANINI HESAPLA (AKILLI) =====
local function shouldParry(ballInfo)
    if not ballInfo then return false end
    
    local timeToHit = ballInfo.timeToHit
    local distance = ballInfo.distance
    local dotProduct = ballInfo.dotProduct
    
    -- VuruÅŸ moduna gÃ¶re zamanlama
    local threshold = settings.PredictTime
    
    if settings.ParryMode == "AGGRESSIVE" then
        threshold = threshold * 0.8  -- Daha erken vur
    elseif settings.ParryMode == "INSTANT" then
        threshold = threshold * 1.5  -- Ã‡ok erken vur
    end
    
    -- Dot product'a gÃ¶re hassasiyet ayarÄ±
    if dotProduct > 0.8 then
        threshold = threshold * 0.9  -- Tam Ã¼stÃ¼ne geliyorsa daha erken vur
    end
    
    -- Åžans faktÃ¶rÃ¼ (HitChance)
    if math.random() > settings.HitChance then
        return false  -- Bazen kaÃ§Ä±r (doÄŸal gÃ¶rÃ¼nsÃ¼n diye)
    end
    
    return timeToHit <= threshold and distance <= settings.MaxDistance
end

-- ===== VURUÅž YAP (EN HIZLI YÃ–NTEM) =====
local function doParry(ballInfo)
    if not settings.Enabled then return end
    
    local now = tick()
    if now - lastParryTime < 0.08 then return end  -- Cooldown
    
    -- Ã‡oklu vuruÅŸ yÃ¶ntemi (her ihtimale karÅŸÄ±)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
    task.wait(0.01)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
    
    -- Yedek vuruÅŸ (remote event)
    local remote = game:GetService("ReplicatedStorage"):FindFirstChild("Parry") 
            or game:GetService("ReplicatedStorage"):FindFirstChild("Swing")
            or game:GetService("ReplicatedStorage"):FindFirstChild("Block")
    if remote then
        remote:FireServer(ballInfo.ball)
    end
    
    lastParryTime = now
    
    -- GÃ¶rsel efekt
    if settings.Visuals.Enabled and settings.Visuals.ImpactMarker then
        createImpactEffect(ballInfo.ball.Position + ballInfo.data.velocity * ballInfo.timeToHit)
    end
end

-- ===== GÃ–RSEL EFEKTLER (ESP) =====
local function createVisuals()
    -- Eski objeleri temizle
    for _, obj in ipairs(visualObjects) do
        pcall(function() obj:Destroy() end)
    end
    visualObjects = {}
    
    if not settings.Visuals.Enabled then return end
    
    local character = player.Character
    if not character then return end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local balls = findBalls()
    
    for _, ball in ipairs(balls) do
        local data = getBallData(ball)
        
        if data.isDangerous and data.speed > 5 then
            -- Top-oyuncu Ã§izgisi
            if settings.Visuals.BallLines then
                local line = createLine(ball.Position, hrp.Position, settings.Visuals.Colors.Line)
                table.insert(visualObjects, line)
            end
            
            -- Tahmin rotasÄ±
            if settings.Visuals.Trajectory and data.speed > 0 then
                local futurePos = ball.Position + data.velocity * 2  -- 2 saniyelik tahmin
                local trajectory = createLine(ball.Position, futurePos, settings.Visuals.Colors.Trajectory)
                table.insert(visualObjects, trajectory)
            end
            
            -- Tahmin noktalarÄ±
            if settings.Visuals.PredictionDots then
                for i = 1, 5 do
                    local time = i * 0.2
                    local pos = ball.Position + data.velocity * time
                    local dot = createDot(pos, settings.Visuals.Colors.Prediction, 0.5)
                    table.insert(visualObjects, dot)
                end
            end
        end
    end
end

-- ===== YARDIMCI FONKSÄ°YONLAR (Ã‡Ä°ZGÄ°, NOKTA OLUÅžTURMA) =====
function createLine(startPos, endPos, color)
    local distance = (endPos - startPos).Magnitude
    if distance < 0.1 then return end
    
    local line = Instance.new("Part")
    line.Size = Vector3.new(settings.Visuals.Thickness, settings.Visuals.Thickness, distance)
    line.CFrame = CFrame.lookAt(startPos, endPos) * CFrame.new(0, 0, -distance/2)
    line.Anchored = true
    line.CanCollide = false
    line.Material = Enum.Material.Neon
    line.BrickColor = BrickColor.new(color)
    line.Transparency = settings.Visuals.Transparency
    line.Parent = Workspace
    
    return line
end

function createDot(position, color, size)
    local dot = Instance.new("Part")
    dot.Size = Vector3.new(size, size, size)
    dot.Shape = Enum.PartType.Ball
    dot.Position = position
    dot.Anchored = true
    dot.CanCollide = false
    dot.Material = Enum.Material.Neon
    dot.BrickColor = BrickColor.new(color)
    dot.Transparency = settings.Visuals.Transparency
    dot.Parent = Workspace
    
    return dot
end

function createImpactEffect(position)
    local impact = Instance.new("Part")
    impact.Size = Vector3.new(2, 2, 2)
    impact.Shape = Enum.PartType.Ball
    impact.Position = position
    impact.Anchored = true
    impact.CanCollide = false
    impact.Material = Enum.Material.Neon
    impact.BrickColor = BrickColor.new(settings.Visuals.Colors.Impact)
    impact.Transparency = 0.2
    impact.Parent = Workspace
    
    table.insert(visualObjects, impact)
    
    -- 1 saniye sonra sil
    task.delay(1, function()
        pcall(function() impact:Destroy() end)
    end)
end

-- ===== GUI OLUÅžTUR =====
local function createGUI()
    local gui = Instance.new("ScreenGui")
    gui.Name = "UltimateBladeBall"
    gui.Parent = CoreGui
    gui.ResetOnSpawn = false
    
    local main = Instance.new("Frame")
    main.Size = UDim2.new(0, 250, 0, 300)
    main.Position = UDim2.new(0.02, 0, 0.3, 0)
    main.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    main.BackgroundTransparency = 0.1
    main.BorderSizePixel = 0
    main.Parent = gui
    main.Active = true
    main.Draggable = true
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 15)
    corner.Parent = main
    
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.Color = Color3.fromRGB(0, 200, 255)
    stroke.Parent = main
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    title.Text = "âš¡ ULTIMATE V4"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 20
    title.Parent = main
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 15)
    titleCorner.Parent = title
    
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Size = UDim2.new(0.8, 0, 0, 40)
    toggleBtn.Position = UDim2.new(0.1, 0, 0.15, 0)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    toggleBtn.Text = "âœ… AKTÄ°F"
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.TextSize = 16
    toggleBtn.Parent = main
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 10)
    btnCorner.Parent = toggleBtn
    
    local modeBtn = Instance.new("TextButton")
    modeBtn.Size = UDim2.new(0.8, 0, 0, 35)
    modeBtn.Position = UDim2.new(0.1, 0, 0.3, 0)
    modeBtn.BackgroundColor3 = Color3.fromRGB(255, 150, 0)
    modeBtn.Text = "MOD: " .. settings.ParryMode
    modeBtn.TextColor3 = Color3.new(1, 1, 1)
    modeBtn.Font = Enum.Font.Gotham
    modeBtn.TextSize = 14
    modeBtn.Parent = main
    
    local modeCorner = Instance.new("UICorner")
    modeCorner.CornerRadius = UDim.new(0, 8)
    modeCorner.Parent = modeBtn
    
    local espBtn = Instance.new("TextButton")
    espBtn.Size = UDim2.new(0.8, 0, 0, 35)
    espBtn.Position = UDim2.new(0.1, 0, 0.45, 0)
    espBtn.BackgroundColor3 = settings.Visuals.Enabled and Color3.fromRGB(0, 150, 200) or Color3.fromRGB(100, 100, 100)
    espBtn.Text = settings.Visuals.Enabled and "ðŸ‘ï¸ ESP: AÃ‡IK" or "ðŸ‘ï¸ ESP: KAPALI"
    espBtn.TextColor3 = Color3.new(1, 1, 1)
    espBtn.Font = Enum.Font.Gotham
    espBtn.TextSize = 14
    espBtn.Parent = main
    
    local espCorner = Instance.new("UICorner")
    espCorner.CornerRadius = UDim.new(0, 8)
    espCorner.Parent = espBtn
    
    local timeSlider = Instance.new("TextLabel")
    timeSlider.Size = UDim2.new(0.8, 0, 0, 20)
    timeSlider.Position = UDim2.new(0.1, 0, 0.6, 0)
    timeSlider.BackgroundTransparency = 1
    timeSlider.Text = "Zamanlama: " .. settings.PredictTime
    timeSlider.TextColor3 = Color3.new(1, 1, 1)
    timeSlider.Font = Enum.Font.Gotham
    timeSlider.TextSize = 14
    timeSlider.Parent = main
    
    local timeUp = Instance.new("TextButton")
    timeUp.Size = UDim2.new(0.2, 0, 0, 25)
    timeUp.Position = UDim2.new(0.1, 0, 0.65, 0)
    timeUp.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    timeUp.Text = "+"
    timeUp.TextColor3 = Color3.new(1, 1, 1)
    timeUp.Font = Enum.Font.GothamBold
    timeUp.TextSize = 16
    timeUp.Parent = main
    
    local timeDown = Instance.new("TextButton")
    timeDown.Size = UDim2.new(0.2, 0, 0, 25)
    timeDown.Position = UDim2.new(0.7, 0, 0.65, 0)
    timeDown.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    timeDown.Text = "-"
    timeDown.TextColor3 = Color3.new(1, 1, 1)
    timeDown.Font = Enum.Font.GothamBold
    timeDown.TextSize = 16
    timeDown.Parent = main
    
    local credit = Instance.new("TextLabel")
    credit.Size = UDim2.new(1, 0, 0, 30)
    credit.Position = UDim2.new(0, 0, 1, -30)
    credit.BackgroundTransparency = 1
    credit.Text = "âš¡ 31 AKTÄ°F âš¡"
    credit.TextColor3 = Color3.fromRGB(255, 50, 50)
    credit.Font = Enum.Font.GothamBold
    credit.TextSize = 16
    credit.Parent = main
    
    -- ===== BUTON FONKSÄ°YONLARI =====
    toggleBtn.MouseButton1Click:Connect(function()
        settings.Enabled = not settings.Enabled
        toggleBtn.BackgroundColor3 = settings.Enabled and Color3.fromRGB(0, 200, 100) or Color3.fromRGB(200, 0, 0)
        toggleBtn.Text = settings.Enabled and "âœ… AKTÄ°F" or "âŒ DEVRE DIÅžI"
    end)
    
    modeBtn.MouseButton1Click:Connect(function()
        if settings.ParryMode == "NORMAL" then
            settings.ParryMode = "AGGRESSIVE"
        elseif settings.ParryMode == "AGGRESSIVE" then
            settings.ParryMode = "INSTANT"
        else
            settings.ParryMode = "NORMAL"
        end
        modeBtn.Text = "MOD: " .. settings.ParryMode
    end)
    
    espBtn.MouseButton1Click:Connect(function()
        settings.Visuals.Enabled = not settings.Visuals.Enabled
        espBtn.BackgroundColor3 = settings.Visuals.Enabled and Color3.fromRGB(0, 150, 200) or Color3.fromRGB(100, 100, 100)
        espBtn.Text = settings.Visuals.Enabled and "ðŸ‘ï¸ ESP: AÃ‡IK" or "ðŸ‘ï¸ ESP: KAPALI"
    end)
    
    timeUp.MouseButton1Click:Connect(function()
        settings.PredictTime = math.min(0.8, settings.PredictTime + 0.05)
        timeSlider.Text = "Zamanlama: " .. string.format("%.2f", settings.PredictTime)
    end)
    
    timeDown.MouseButton1Click:Connect(function()
        settings.PredictTime = math.max(0.2, settings.PredictTime - 0.05)
        timeSlider.Text = "Zamanlama: " .. string.format("%.2f", settings.PredictTime)
    end)
    
    return gui
end

-- ===== ANA DÃ–NGÃœ =====
local gui = createGUI()

-- RGB efekt dÃ¶ngÃ¼sÃ¼
spawn(function()
    while true do
        for _, obj in ipairs(gui:GetDescendants()) do
            if obj:IsA("UIStroke") and obj.Parent == gui:FindFirstChild("Frame") then
                local hue = tick() % 5 / 5
                obj.Color = Color3.fromHSV(hue, 1, 1)
            end
        end
        task.wait(0.05)
    end
end)

-- Ana algÄ±lama dÃ¶ngÃ¼sÃ¼
RunService.Heartbeat:Connect(function()
    if not settings.Enabled then return end
    
    local dangerous = findMostDangerousBall()
    if dangerous and shouldParry(dangerous) then
        doParry(dangerous)
    end
end)

-- GÃ¶rsel gÃ¼ncelleme dÃ¶ngÃ¼sÃ¼
RunService.RenderStepped:Connect(function()
    createVisuals()
end)

-- TuÅŸ kontrolÃ¼
UserInputService.InputBegan:Connect(function(input, gpe)
    if not gpe and input.KeyCode == settings.Keybind then
        settings.Enabled = not settings.Enabled
        print("âš¡ Ultimate Blade Ball:", settings.Enabled and "AKTÄ°F" or "DEVRE DIÅžI")
    end
end)

-- Karakter yeniden doÄŸunca
player.CharacterAdded:Connect(function()
    task.wait(0.5)
    -- HÄ±zlÄ± reset
end)

-- BaÅŸlangÄ±Ã§ bildirimi
local notification = Instance.new("TextLabel")
notification.Size = UDim2.new(0, 350, 0, 80)
notification.Position = UDim2.new(0.5, -175, 0.8, 0)
notification.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
notification.BackgroundTransparency = 0.2
notification.Text = "âš¡ 31 AKTÄ°F âš¡\nULTIMATE BLADE BALL V4"
notification.TextColor3 = Color3.new(1, 1, 1)
notification.Font = Enum.Font.GothamBold
notification.TextSize = 24
notification.TextWrapped = true
notification.Parent = CoreGui

local notifCorner = Instance.new("UICorner")
notifCorner.CornerRadius = UDim.new(0, 20)
notifCorner.Parent = notification

task.delay(4, function()
    notification:Destroy()
end)

print("âœ… ULTIMATE BLADE BALL V4 YÃœKLENDÄ°!")
print("ðŸŽ¯ Mod:", settings.ParryMode, "| Zamanlama:", settings.PredictTime)
