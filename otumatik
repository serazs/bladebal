-- BLADE BALL ULTIMATE AUTO PARRY v5 (EN GELƒ∞≈ûMƒ∞≈û)
-- Hazƒ±r k√ºt√ºphaneler ve optimizasyonlarla donatƒ±lmƒ±≈ütƒ±r

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

-- ===== K√úT√úPHANELER (g√ºvenli ve hƒ±zlƒ±) =====
local Library = {
    -- √áizim k√ºt√ºphanesi (Drawing destekleniyorsa kullan, yoksa Part tabanlƒ±)
    Drawing = pcall(function() return Drawing.new("Line") end) and Drawing or nil,
    
    -- Notification k√ºt√ºphanesi (basit)
    notify = function(msg, duration)
        local notif = Instance.new("ScreenGui")
        notif.Name = "Notification"
        notif.Parent = CoreGui
        notif.ResetOnSpawn = false
        
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 300, 0, 60)
        frame.Position = UDim2.new(0.5, -150, 0.8, 0)
        frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        frame.BackgroundTransparency = 0.2
        frame.BorderSizePixel = 0
        frame.Parent = notif
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 15)
        corner.Parent = frame
        
        local text = Instance.new("TextLabel")
        text.Size = UDim2.new(1, -20, 1, 0)
        text.Position = UDim2.new(0, 10, 0, 0)
        text.BackgroundTransparency = 1
        text.Text = msg
        text.TextColor3 = Color3.new(1, 1, 1)
        text.Font = Enum.Font.GothamBold
        text.TextSize = 20
        text.TextWrapped = true
        text.Parent = frame
        
        task.delay(duration or 3, function()
            frame:TweenPosition(UDim2.new(0.5, -150, 1, 0), Enum.EasingDirection.In, Enum.EasingStyle.Quint, 0.5, true)
            task.delay(0.5, function() notif:Destroy() end)
        end)
    end
}

-- ===== TOP Y√ñNETƒ∞Cƒ∞Sƒ∞ (optimize edilmi≈ü) =====
local BallManager = {
    balls = {},
    folder = nil,
    initialized = false,
    
    init = function(self)
        -- Top klas√∂r√ºn√º bul
        local possibleFolders = {"Balls", "Projectiles", "Throwables", "BallFolder"}
        for _, name in ipairs(possibleFolders) do
            local f = Workspace:FindFirstChild(name)
            if f then
                self.folder = f
                break
            end
        end
        
        if not self.folder then
            Library.notify("‚ùå Top klas√∂r√º bulunamadƒ±!", 3)
            return false
        end
        
        -- Mevcut toplarƒ± ekle
        for _, ball in ipairs(self.folder:GetChildren()) do
            if ball:IsA("BasePart") then
                table.insert(self.balls, ball)
            end
        end
        
        -- Yeni top eklendiƒüinde listeye ekle
        self.folder.ChildAdded:Connect(function(child)
            if child:IsA("BasePart") then
                table.insert(self.balls, child)
            end
        end)
        
        -- Top silindiƒüinde listeden √ßƒ±kar
        self.folder.ChildRemoved:Connect(function(child)
            for i, ball in ipairs(self.balls) do
                if ball == child then
                    table.remove(self.balls, i)
                    break
                end
            end
        end)
        
        self.initialized = true
        return true
    end,
    
    getBalls = function(self)
        return self.balls
    end
}

-- ===== TOP VERƒ∞LERƒ∞Nƒ∞ AL (hƒ±zlƒ±) =====
local function getBallData(ball)
    local data = {
        position = ball.Position,
        velocity = ball.Velocity,
        speed = ball.Velocity.Magnitude,
        target = ball:GetAttribute("target")
    }
    
    -- Eƒüer velocity sƒ±fƒ±rsa AssemblyLinearVelocity'yi dene
    if data.speed < 0.1 then
        data.velocity = ball.AssemblyLinearVelocity
        data.speed = data.velocity.Magnitude
    end
    
    -- Hala sƒ±fƒ±rsa BodyVelocity ara
    if data.speed < 0.1 then
        for _, child in ipairs(ball:GetChildren()) do
            if child:IsA("BodyVelocity") then
                data.velocity = child.Velocity
                data.speed = data.velocity.Magnitude
                break
            end
        end
    end
    
    return data
end

-- ===== OYUNCUYA GELEN TOPLARI BUL =====
local function getIncomingBalls()
    local character = player.Character
    if not character then return {} end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return {} end
    
    local incoming = {}
    local balls = BallManager:getBalls()
    
    for _, ball in ipairs(balls) do
        local data = getBallData(ball)
        if data.speed > 5 then  -- hƒ±zlƒ± toplar
            -- Hedef kontrol√º
            if data.target and data.target ~= player.Name then
                goto continue
            end
            
            local toPlayer = hrp.Position - data.position
            local distance = toPlayer.Magnitude
            local direction = data.velocity.unit
            local dot = toPlayer.unit:Dot(direction)
            
            -- Oyuncuya doƒüru geliyor mu? (dot > 0.3)
            if dot > 0.3 then
                local timeToHit = distance / data.speed
                table.insert(incoming, {
                    ball = ball,
                    data = data,
                    distance = distance,
                    timeToHit = timeToHit,
                    dot = dot
                })
            end
        end
        ::continue::
    end
    
    -- Zamana g√∂re sƒ±rala (en yakƒ±n olan √∂nce)
    table.sort(incoming, function(a, b) return a.timeToHit < b.timeToHit end)
    
    return incoming
end

-- ===== VURU≈û ZAMANI KONTROL√ú =====
local function shouldParry(ballInfo, settings)
    local timeToHit = ballInfo.timeToHit
    local distance = ballInfo.distance
    local dot = ballInfo.dot
    
    -- Ayarlara g√∂re e≈üik deƒüeri
    local threshold = settings.ParryTime
    
    -- Dot product'a g√∂re hassasiyet
    if dot > 0.9 then
        threshold = threshold * 0.9  -- tam √ºst√ºne geliyorsa daha erken vur
    elseif dot < 0.5 then
        return false  -- √ßok a√ßƒ±lƒ± geliyorsa vurma
    end
    
    -- Mesafe √ßok uzaksa vurma
    if distance > settings.MaxDistance then
        return false
    end
    
    -- Zaman kontrol√º
    return timeToHit <= threshold
end

-- ===== VURU≈û YAP (redundant y√∂ntemler) =====
local function performParry(ball)
    -- Y√∂ntem 1: VirtualInputManager ile tƒ±klama
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
    task.wait(0.01)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
    
    -- Y√∂ntem 2: Remote event (varsa)
    local remote = ReplicatedStorage:FindFirstChild("Parry") or
                   ReplicatedStorage:FindFirstChild("Swing") or
                   ReplicatedStorage:FindFirstChild("Block") or
                   ReplicatedStorage:FindFirstChild("Hit")
    if remote then
        remote:FireServer(ball)
    end
    
    -- Y√∂ntem 3: Klavye sim√ºlasyonu (F tu≈üu)
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.F, false, game)
    task.wait(0.01)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.F, false, game)
end

-- ===== G√ñRSEL √áƒ∞Zƒ∞MLER (ESP) =====
local VisualManager = {
    objects = {},
    
    clear = function(self)
        for _, obj in ipairs(self.objects) do
            pcall(function() obj:Destroy() end)
        end
        self.objects = {}
    end,
    
    drawLine = function(self, startPos, endPos, color, thickness)
        local distance = (endPos - startPos).Magnitude
        if distance < 0.5 then return end
        
        local line = Instance.new("Part")
        line.Size = Vector3.new(thickness or 0.3, thickness or 0.3, distance)
        line.CFrame = CFrame.lookAt(startPos, endPos) * CFrame.new(0, 0, -distance/2)
        line.Anchored = true
        line.CanCollide = false
        line.Material = Enum.Material.Neon
        line.BrickColor = BrickColor.new(color)
        line.Transparency = 0.3
        line.Parent = Workspace
        
        table.insert(self.objects, line)
        return line
    end,
    
    drawDot = function(self, position, color, size)
        local dot = Instance.new("Part")
        dot.Size = Vector3.new(size or 0.8, size or 0.8, size or 0.8)
        dot.Shape = Enum.PartType.Ball
        dot.Position = position
        dot.Anchored = true
        dot.CanCollide = false
        dot.Material = Enum.Material.Neon
        dot.BrickColor = BrickColor.new(color)
        dot.Transparency = 0.2
        dot.Parent = Workspace
        
        table.insert(self.objects, dot)
        return dot
    end,
    
    updateESP = function(self, incomingBalls, settings)
        self:clear()
        
        if not settings.Visuals.Enabled then return end
        
        local character = player.Character
        if not character then return end
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        for _, ballInfo in ipairs(incomingBalls) do
            local ball = ballInfo.ball
            local data = ballInfo.data
            
            -- Top-oyuncu √ßizgisi
            if settings.Visuals.BallLines then
                self:drawLine(ball.Position, hrp.Position, settings.Visuals.Colors.Line, 0.3)
            end
            
            -- Tahmin rotasƒ±
            if settings.Visuals.Trajectory and data.speed > 5 then
                local futurePos = ball.Position + data.velocity * 2
                self:drawLine(ball.Position, futurePos, settings.Visuals.Colors.Trajectory, 0.2)
            end
            
            -- Tahmin noktalarƒ±
            if settings.Visuals.PredictionDots then
                for i = 1, 5 do
                    local t = i * 0.2
                    local pos = ball.Position + data.velocity * t
                    self:drawDot(pos, settings.Visuals.Colors.Prediction, 0.4)
                end
            end
        end
    end
}

-- ===== AYARLAR =====
local settings = {
    Enabled = true,
    ParryTime = 0.45,
    MaxDistance = 35,
    ParryMode = "AGGRESSIVE",  -- NORMAL, AGGRESSIVE, INSTANT
    Visuals = {
        Enabled = true,
        BallLines = true,
        PredictionDots = true,
        Trajectory = true,
        Colors = {
            Line = Color3.fromRGB(255, 50, 50),
            Prediction = Color3.fromRGB(50, 255, 50),
            Trajectory = Color3.fromRGB(255, 255, 0)
        }
    }
}

-- ===== GUI OLU≈ûTURMA =====
local function createGUI()
    local gui = Instance.new("ScreenGui")
    gui.Name = "BladeBallUltimate"
    gui.Parent = CoreGui
    gui.ResetOnSpawn = false
    
    local main = Instance.new("Frame")
    main.Size = UDim2.new(0, 250, 0, 280)
    main.Position = UDim2.new(0.02, 0, 0.3, 0)
    main.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    main.BackgroundTransparency = 0.1
    main.BorderSizePixel = 0
    main.Parent = gui
    main.Active = true
    main.Draggable = true
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 15)
    corner.Parent = main
    
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.Color = Color3.fromRGB(0, 200, 255)
    stroke.Parent = main
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    title.Text = "‚ö° BLADE BALL ULTIMATE"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.Parent = main
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 15)
    titleCorner.Parent = title
    
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Size = UDim2.new(0.8, 0, 0, 35)
    toggleBtn.Position = UDim2.new(0.1, 0, 0.15, 0)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 100)
    toggleBtn.Text = "‚úÖ AKTƒ∞F"
    toggleBtn.TextColor3 = Color3.new(1, 1, 1)
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.TextSize = 14
    toggleBtn.Parent = main
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 8)
    btnCorner.Parent = toggleBtn
    
    local modeBtn = Instance.new("TextButton")
    modeBtn.Size = UDim2.new(0.8, 0, 0, 30)
    modeBtn.Position = UDim2.new(0.1, 0, 0.3, 0)
    modeBtn.BackgroundColor3 = Color3.fromRGB(255, 150, 0)
    modeBtn.Text = "MOD: " .. settings.ParryMode
    modeBtn.TextColor3 = Color3.new(1, 1, 1)
    modeBtn.Font = Enum.Font.Gotham
    modeBtn.TextSize = 12
    modeBtn.Parent = main
    
    local modeCorner = Instance.new("UICorner")
    modeCorner.CornerRadius = UDim.new(0, 8)
    modeCorner.Parent = modeBtn
    
    local espBtn = Instance.new("TextButton")
    espBtn.Size = UDim2.new(0.8, 0, 0, 30)
    espBtn.Position = UDim2.new(0.1, 0, 0.45, 0)
    espBtn.BackgroundColor3 = settings.Visuals.Enabled and Color3.fromRGB(0, 150, 200) or Color3.fromRGB(100, 100, 100)
    espBtn.Text = settings.Visuals.Enabled and "üëÅÔ∏è ESP: A√áIK" or "üëÅÔ∏è ESP: KAPALI"
    espBtn.TextColor3 = Color3.new(1, 1, 1)
    espBtn.Font = Enum.Font.Gotham
    espBtn.TextSize = 12
    espBtn.Parent = main
    
    local espCorner = Instance.new("UICorner")
    espCorner.CornerRadius = UDim.new(0, 8)
    espCorner.Parent = espBtn
    
    local timeLabel = Instance.new("TextLabel")
    timeLabel.Size = UDim2.new(0.8, 0, 0, 20)
    timeLabel.Position = UDim2.new(0.1, 0, 0.6, 0)
    timeLabel.BackgroundTransparency = 1
    timeLabel.Text = "Zamanlama: " .. settings.ParryTime
    timeLabel.TextColor3 = Color3.new(1, 1, 1)
    timeLabel.Font = Enum.Font.Gotham
    timeLabel.TextSize = 12
    timeLabel.Parent = main
    
    local timeUp = Instance.new("TextButton")
    timeUp.Size = UDim2.new(0.2, 0, 0, 25)
    timeUp.Position = UDim2.new(0.1, 0, 0.65, 0)
    timeUp.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    timeUp.Text = "+"
    timeUp.TextColor3 = Color3.new(1, 1, 1)
    timeUp.Font = Enum.Font.GothamBold
    timeUp.TextSize = 14
    timeUp.Parent = main
    
    local timeDown = Instance.new("TextButton")
    timeDown.Size = UDim2.new(0.2, 0, 0, 25)
    timeDown.Position = UDim2.new(0.7, 0, 0.65, 0)
    timeDown.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    timeDown.Text = "-"
    timeDown.TextColor3 = Color3.new(1, 1, 1)
    timeDown.Font = Enum.Font.GothamBold
    timeDown.TextSize = 14
    timeDown.Parent = main
    
    local credit = Instance.new("TextLabel")
    credit.Size = UDim2.new(1, 0, 0, 25)
    credit.Position = UDim2.new(0, 0, 1, -25)
    credit.BackgroundTransparency = 1
    credit.Text = "‚ö° 31 AKTƒ∞F ‚ö°"
    credit.TextColor3 = Color3.fromRGB(255, 50, 50)
    credit.Font = Enum.Font.GothamBold
    credit.TextSize = 14
    credit.Parent = main
    
    -- Buton fonksiyonlarƒ±
    toggleBtn.MouseButton1Click:Connect(function()
        settings.Enabled = not settings.Enabled
        toggleBtn.BackgroundColor3 = settings.Enabled and Color3.fromRGB(0, 200, 100) or Color3.fromRGB(200, 0, 0)
        toggleBtn.Text = settings.Enabled and "‚úÖ AKTƒ∞F" or "‚ùå DEVRE DI≈ûI"
    end)
    
    modeBtn.MouseButton1Click:Connect(function()
        if settings.ParryMode == "NORMAL" then
            settings.ParryMode = "AGGRESSIVE"
        elseif settings.ParryMode == "AGGRESSIVE" then
            settings.ParryMode = "INSTANT"
        else
            settings.ParryMode = "NORMAL"
        end
        modeBtn.Text = "MOD: " .. settings.ParryMode
        
        -- Moda g√∂re ParryTime'ƒ± otomatik ayarla
        if settings.ParryMode == "NORMAL" then
            settings.ParryTime = 0.5
        elseif settings.ParryMode == "AGGRESSIVE" then
            settings.ParryTime = 0.4
        else -- INSTANT
            settings.ParryTime = 0.3
        end
        timeLabel.Text = "Zamanlama: " .. string.format("%.2f", settings.ParryTime)
    end)
    
    espBtn.MouseButton1Click:Connect(function()
        settings.Visuals.Enabled = not settings.Visuals.Enabled
        espBtn.BackgroundColor3 = settings.Visuals.Enabled and Color3.fromRGB(0, 150, 200) or Color3.fromRGB(100, 100, 100)
        espBtn.Text = settings.Visuals.Enabled and "üëÅÔ∏è ESP: A√áIK" or "üëÅÔ∏è ESP: KAPALI"
    end)
    
    timeUp.MouseButton1Click:Connect(function()
        settings.ParryTime = math.min(0.8, settings.ParryTime + 0.05)
        timeLabel.Text = "Zamanlama: " .. string.format("%.2f", settings.ParryTime)
    end)
    
    timeDown.MouseButton1Click:Connect(function()
        settings.ParryTime = math.max(0.2, settings.ParryTime - 0.05)
        timeLabel.Text = "Zamanlama: " .. string.format("%.2f", settings.ParryTime)
    end)
    
    return gui
end

-- ===== BA≈ûLANGI√á =====
local function initialize()
    Library.notify("‚ö° Blade Ball Ultimate Y√ºkleniyor...", 2)
    
    -- Top y√∂neticisini ba≈ülat
    if not BallManager:init() then
        Library.notify("‚ùå Top klas√∂r√º bulunamadƒ±!", 3)
        return
    end
    
    -- GUI olu≈ütur
    local gui = createGUI()
    
    -- RGB efekti
    spawn(function()
        while gui and gui.Parent do
            local hue = tick() % 5 / 5
            local stroke = gui:FindFirstChild("Frame"):FindFirstChild("UIStroke")
            if stroke then
                stroke.Color = Color3.fromHSV(hue, 1, 1)
            end
            task.wait(0.05)
        end
    end)
    
    -- Ana d√∂ng√º
    local lastParryTime = 0
    RunService.Heartbeat:Connect(function()
        if not settings.Enabled then return end
        
        local incoming = getIncomingBalls()
        if #incoming > 0 then
            local best = incoming[1]  -- en yakƒ±n top
            
            if shouldParry(best, settings) then
                local now = tick()
                if now - lastParryTime > 0.1 then  -- cooldown
                    performParry(best.ball)
                    lastParryTime = now
                end
            end
        end
        
        -- ESP g√ºncelle
        VisualManager:updateESP(incoming, settings)
    end)
    
    Library.notify("‚úÖ Script ba≈üarƒ±yla y√ºklendi! F tu≈üu ile a√ß/kapa.", 3)
    
    -- F tu≈üu ile a√ß/kapa
    UserInputService.InputBegan:Connect(function(input, gpe)
        if not gpe and input.KeyCode == Enum.KeyCode.F then
            settings.Enabled = not settings.Enabled
            Library.notify(settings.Enabled and "‚úÖ Auto Parry AKTƒ∞F" or "‚ùå Auto Parry DEVRE DI≈ûI", 1.5)
        end
    end)
end

-- Her ≈üeyi ba≈ülat
initialize()
